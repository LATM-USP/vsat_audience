---
import NoStories from "@components/story/NoStories.astro";
import StoriesHeader from "@components/story/StoriesHeader/StoriesHeaderIsland";
import StorySummaryGrid from "@components/story/summary/grid/StorySummaryGrid.astro";
import { isNonEmptyArray } from "@util/nonEmptyArray";

import Layout from "../../../layouts/AuthoringLayout.astro";

import groupByPublicationStatus from "./_groupByPublicationStatus.js";

const user = Astro.locals.user;
if (!user?.id) {
  return Astro.redirect("/login");
}

const { repositoryStory, i18n, log } = Astro.locals.environment<
  App.WithStoryRepository & App.WithI18N & App.WithLog
>();

let stories = await repositoryStory.getStorySummariesByAuthor(user.id);

if (!stories) {
  stories = {
    author: {
      id: user.id,
      name: user.name,
    },
    stories: [],
  };
}

const translations = i18n.getTranslationsForPage({
  locale: Astro.preferredLocale,
  page: "stories",
});

const [publishedStories, unpublishedStories] = groupByPublicationStatus(
  stories.stories,
);

log.info(
  {
    publishedStories,
    unpublishedStories,
  },
  "Stories",
);

const thereIsAtLeastOneStory = isNonEmptyArray(stories.stories);
---

<Layout
  title={i18n.t("page.stories.meta.title")}
  description={i18n.t("page.stories.meta.description")}
>
  <main>
    <StoriesHeader
      author={stories.author}
      translations={translations}
      showCreateStory={isNonEmptyArray(stories.stories)}
      client:only="react"
    />

    {!thereIsAtLeastOneStory && <NoStories translations={translations} />}

    {
      isNonEmptyArray(unpublishedStories) && (
        <StorySummaryGrid
          stories={[...unpublishedStories, ...unpublishedStories]}
        >
          <h2 slot="header" class="header">
            Unpublished stories
          </h2>
          <div slot="blurb" class="blurb">
            These are the stories you're working on. Only you can see them.
          </div>
        </StorySummaryGrid>
      )
    }

    {
      isNonEmptyArray(publishedStories) && (
        <StorySummaryGrid
          stories={[
            ...publishedStories,
            ...publishedStories,
            ...publishedStories,
          ]}
        >
          <h2 slot="header" class="header">
            Published stories
          </h2>
          <div slot="blurb" class="blurb">
            These are all of your published stories. Anyone with the link to
            your published story can read it.
          </div>
        </StorySummaryGrid>
      )
    }
  </main>
</Layout>

<style>
  main {
    display: flex;
    flex-direction: column;
    gap: 1rem;

    margin: 2rem auto;
    width: 1000px;
  }

  .header,
  .blurb {
    color: var(--color-text);
  }
</style>
